<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>Mapa serwisantÃ³w</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet/dist/leaflet.css"
/>

<style>
  body { margin: 0; }
  #map { height: 100vh; }

  .popup input {
    width: 100%;
    margin-top: 6px;
    padding: 4px;
  }

  .popup button {
    width: 100%;
    margin-top: 6px;
    padding: 6px;
    cursor: pointer;
  }

  .copy {
    cursor: pointer;
    margin-left: 6px;
    color: #0077cc;
    font-size: 0.9em;
  }

  .copy:hover {
    text-decoration: underline;
  }
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ===============================
   USTAWIENIA
================================ */
const stawkaDomyslna = 1.2;

/* ===============================
   MAPA
================================ */
const map = L.map('map').setView([52.1, 19.4], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

/* ===============================
   FUNKCJA KOPIOWANIA
================================ */
function copyFrom(id) {
  const text = document.getElementById(id).innerText;
  navigator.clipboard.writeText(text);
  alert("Skopiowano do schowka");
}

/* ===============================
   ÅADOWANIE SERWISANTÃ“W
================================ */
fetch('serwisanci.json')
  .then(res => res.json())
  .then(data => {
    data.forEach(s => {

      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(s.adres + ', ' + s.miasto)}`)
        .then(r => r.json())
        .then(loc => {

          if (!loc[0]) return;

          const lat = loc[0].lat;
          const lon = loc[0].lon;

          const marker = L.marker([lat, lon]).addTo(map);

          marker.bindPopup(`
  <div class="popup">
    <b>${s.nazwa}</b><br>
    ${s.miasto}<br>
    <small>${s.opis || ""}</small><br><br>

    ğŸ“ <a href="tel:${s.telefon}">${s.telefon}</a><br>
    âœ‰ï¸ <a href="mailto:${s.email}">${s.email}</a><br><br>

    ğŸ“¦ <b>Adres do wysyÅ‚ki</b><br>
    <span id="wys${s.id}">${s.adres_do_wysylki}</span>
    <span class="copy" onclick="copyFrom('wys${s.id}')">ğŸ“‹ kopiuj</span><br><br>

    ğŸ“® <b>InPost</b><br>
    <span id="inp${s.id}">${s.inpost}</span>
    <span class="copy" onclick="copyFrom('inp${s.id}')">ğŸ“‹ kopiuj</span><br><br>

    ğŸ§¾ <b>Adres fakturowy</b><br>
    <span id="fak${s.id}">${s.adres_fakturowy}</span>
    <span class="copy" onclick="copyFrom('fak${s.id}')">ğŸ“‹ kopiuj</span><br><br>

    <input id="a${s.id}" placeholder="Adres klienta">
    <button onclick="route(${lat}, ${lon}, 'a${s.id}', ${s.stawka || stawkaDomyslna})">
      Wyznacz trasÄ™ i koszt
    </button>
  </div>
`);
        });
    });
  });

/* ===============================
   ROUTING + KOSZT
================================ */
let routeLayer;

function route(lat, lon, inputId, rate) {

  rate = Number(rate);
  if (isNaN(rate)) rate = stawkaDomyslna;

  const address = document.getElementById(inputId).value;
  if (!address) {
    alert("Wpisz adres klienta");
    return;
  }

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
    .then(r => r.json())
    .then(dest => {

      if (!dest[0]) {
        alert("Nie znaleziono adresu klienta");
        return;
      }

      const dlat = dest[0].lat;
      const dlon = dest[0].lon;

      fetch(`https://router.project-osrm.org/route/v1/driving/${lon},${lat};${dlon},${dlat}?overview=full&geometries=geojson`)
        .then(r => r.json())
        .then(res => {

          const km = res.routes[0].distance / 1000;
          const cost = (km * rate).toFixed(2);

          if (routeLayer) map.removeLayer(routeLayer);

          routeLayer = L.geoJSON(res.routes[0].geometry, {
            style: { color: 'red', weight: 4 }
          }).addTo(map);

          alert(
            `Dystans: ${km.toFixed(1)} km\n` +
            `Koszt: ${cost} zÅ‚\n\n` +
            `Kwota orientacyjna`
          );
        });
    });
}
</script>
</body>
</html>
