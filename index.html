<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>Mapa serwisant√≥w</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
  body { margin: 0; font-family: Arial, sans-serif; }
  #map { height: 65vh; }

  .panel {
    padding: 10px;
    background: #fff;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 6px;
  }

  th { background: #f0f0f0; }

  .popup { font-size: 0.9em; }

  .section-title {
    cursor: pointer;
    font-weight: bold;
    background: #f3f3f3;
    padding: 4px;
    margin-top: 6px;
  }

  .section-content {
    display: none;
    padding: 4px;
  }

  .copy {
    cursor: pointer;
    color: #0077cc;
    margin-left: 6px;
  }
</style>
</head>

<body>

<div class="panel">
  <input id="adresKlienta" placeholder="Adres klienta" style="width:280px;">
  <button onclick="searchOnly()">Poka≈º adres</button>
  <button onclick="routeForSelected()">Wyznacz trasy i koszty</button>
</div>

<div id="map"></div>

<div class="panel">
  <h3>Wyniki (od najbli≈ºszego)</h3>
  <table>
    <thead>
      <tr>
        <th>Serwisant</th>
        <th>Dystans (km)</th>
        <th>Koszt (z≈Ç)</th>
      </tr>
    </thead>
    <tbody id="results"></tbody>
  </table>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ===============================
   KONFIGURACJA
================================ */
const stawkaDomyslna = 1.2;
const colors = ['red','blue','green','purple','orange','brown','black'];
let colorIndex = 0;

/* ===============================
   MAPA
================================ */
const map = L.map('map').setView([52.1, 19.4], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap'
}).addTo(map);

const routesLayer = L.layerGroup().addTo(map);
const selected = new Map();
const markers = new Map();
let clientMarker = null;

/* ===============================
   IKONY
================================ */
const iconNormal = L.icon({
  iconUrl: 'klucz.png',
  iconSize: [36,36],
  iconAnchor: [18,36],
  popupAnchor: [0,-36]
});

const iconSelected = L.icon({
  iconUrl: 'klucz-selected.png',
  iconSize: [36,36],
  iconAnchor: [18,36],
  popupAnchor: [0,-36]
});

/* ===============================
   NARZƒòDZIA
================================ */
function toggleSection(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === 'block' ? 'none' : 'block';
}

function copyFrom(id) {
  navigator.clipboard.writeText(document.getElementById(id).innerText);
}

/* ===============================
   SERWISANCI
================================ */
fetch('serwisanci.json')
  .then(r => r.json())
  .then(data => {

    data.forEach(s => {

      if (!s.lat || !s.lon) return;

      const marker = L.marker([s.lat, s.lon], { icon: iconNormal }).addTo(map);
      markers.set(s.id, marker);

      marker.bindPopup(`
        <div class="popup">
          <b>${s.nazwa}</b><br>
          ${s.miasto}<br>
          <small>${s.opis || ""}</small><br><br>

          üìû ${s.telefon}<br>
          ‚úâÔ∏è ${s.email}<br>

          <div class="section-title" onclick="toggleSection('wys${s.id}')">üì¶ Adres do wysy≈Çki</div>
          <div id="wys${s.id}" class="section-content">${s.adres_do_wysylki || "-"}</div>

          <div class="section-title" onclick="toggleSection('inp${s.id}')">üìÆ InPost</div>
          <div id="inp${s.id}" class="section-content">${s.inpost || "-"}</div>

          <div class="section-title" onclick="toggleSection('fak${s.id}')">üßæ Adres fakturowy</div>
          <div id="fak${s.id}" class="section-content">${s.adres_fakturowy || "-"}</div>

          <br>
          <label>
            <input type="checkbox"
              onchange="toggleSelect(${s.id}, '${s.nazwa}', ${s.lat}, ${s.lon}, ${s.stawka ?? stawkaDomyslna}, this.checked)">
            zaznacz serwisanta
          </label>
        </div>
      `);
    });
  });

/* ===============================
   ZAZNACZANIE
================================ */
function toggleSelect(id, nazwa, lat, lon, stawka, checked) {
  const marker = markers.get(id);

  if (checked) {
    selected.set(id, {
      nazwa,
      lat,
      lon,
      stawka,
      color: colors[colorIndex++ % colors.length]
    });
    marker.setIcon(iconSelected);
    marker.closePopup();
  } else {
    selected.delete(id);
    marker.setIcon(iconNormal);
  }
}

/* ===============================
   TYLKO WYSZUKIWANIE ADRESU
================================ */
function searchOnly() {
  const address = document.getElementById('adresKlienta').value;
  if (!address) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
    .then(r => r.json())
    .then(res => {
      if (!res[0]) return;

      if (clientMarker) map.removeLayer(clientMarker);

      clientMarker = L.marker([res[0].lat, res[0].lon]).addTo(map)
        .bindPopup("Adres klienta")
        .openPopup();

      map.setView([res[0].lat, res[0].lon], 13);
    });
}

/* ===============================
   ROUTING
================================ */
function routeForSelected() {

  const address = document.getElementById('adresKlienta').value;
  if (!address || selected.size === 0) return;

  routesLayer.clearLayers();
  document.getElementById('results').innerHTML = '';

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
    .then(r => r.json())
    .then(dest => {

      const dlat = dest[0].lat;
      const dlon = dest[0].lon;
      const bounds = [];
      const results = [];

      selected.forEach(s => {

        fetch(`https://router.project-osrm.org/route/v1/driving/${s.lon},${s.lat};${dlon},${dlat}?overview=full&geometries=geojson`)
          .then(r => r.json())
          .then(res => {

            const km = res.routes[0].distance / 1000;
            const cost = (km * s.stawka).toFixed(2);

            const layer = L.geoJSON(res.routes[0].geometry, {
              style: { color: s.color, weight: 4 }
            }).addTo(routesLayer);

            bounds.push(layer.getBounds());
            results.push({ nazwa: s.nazwa, km, cost });

            if (results.length === selected.size) {
              results.sort((a,b) => a.km - b.km);
              renderTable(results);
              map.fitBounds(L.featureGroup(bounds).getBounds());
            }
          });
      });
    });
}

/* ===============================
   TABELA
================================ */
function renderTable(results) {
  const tbody = document.getElementById('results');
  results.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.nazwa}</td>
      <td>${r.km.toFixed(1)}</td>
      <td>${r.cost}</td>
    `;
    tbody.appendChild(tr);
  });
}
</script>

</body>
</html>
