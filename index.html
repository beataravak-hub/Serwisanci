<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>Mapa serwisantów</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
  body { margin: 0; font-family: Arial, sans-serif; }
  #map { height: 70vh; }

  .panel {
    padding: 10px;
    background: #fff;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: left;
  }

  th {
    background: #f0f0f0;
    cursor: pointer;
  }

  .popup input { width: 100%; margin-top: 6px; }
  .popup label { font-size: 0.9em; }
</style>
</head>

<body>

<div class="panel">
  <input id="adresKlienta" placeholder="Adres klienta" style="width:300px;">
  <button onclick="routeForSelected()">Wyznacz trasy i koszty</button>
</div>

<div id="map"></div>

<div class="panel">
  <h3>Wyniki (posortowane od najbliższego)</h3>
  <table id="results">
    <thead>
      <tr>
        <th>Serwisant</th>
        <th>Dystans (km)</th>
        <th>Koszt (zł)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ===============================
   USTAWIENIA
================================ */
const stawkaDomyslna = 1.2;
const colors = ['red','blue','green','purple','orange','brown','black'];
let colorIndex = 0;

/* ===============================
   MAPA
================================ */
const map = L.map('map').setView([52.1, 19.4], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap'
}).addTo(map);

const routesLayer = L.layerGroup().addTo(map);
const selected = new Map();

/* ===============================
   IKONA
================================ */
const kluczIcon = L.icon({
  iconUrl: 'klucz.png',
  iconSize: [36,36],
  iconAnchor: [18,36],
  popupAnchor: [0,-36]
});

/* ===============================
   ŁADOWANIE SERWISANTÓW
================================ */
fetch('serwisanci.json')
  .then(r => r.json())
  .then(data => {

    data.forEach(s => {

      if (!s.lat || !s.lon) return;

      const marker = L.marker([s.lat, s.lon], { icon: kluczIcon }).addTo(map);

      marker.on('click', () => routesLayer.clearLayers());

      marker.bindPopup(`
        <div class="popup">
          <b>${s.nazwa}</b><br>
          ${s.miasto}<br>
          <small>${s.opis || ""}</small><br><br>

          <label>
            <input type="checkbox"
              onchange="toggleSelect(${s.id}, '${s.nazwa}', ${s.lat}, ${s.lon}, ${s.stawka ?? stawkaDomyslna}, this.checked)">
            zaznacz serwisanta
          </label>
        </div>
      `);
    });
  });

/* ===============================
   ZAZNACZANIE
================================ */
function toggleSelect(id, nazwa, lat, lon, stawka, checked) {
  if (checked) {
    selected.set(id, { nazwa, lat, lon, stawka: Number(stawka), color: colors[colorIndex++ % colors.length] });
  } else {
    selected.delete(id);
  }
}

/* ===============================
   ROUTING WIELOKROTNY
================================ */
function routeForSelected() {

  const address = document.getElementById('adresKlienta').value;
  if (!address || selected.size === 0) return;

  routesLayer.clearLayers();
  document.querySelector('#results tbody').innerHTML = '';

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
    .then(r => r.json())
    .then(dest => {

      if (!dest[0]) return;

      const dlat = dest[0].lat;
      const dlon = dest[0].lon;
      const bounds = [];

      const results = [];

      selected.forEach(s => {

        fetch(`https://router.project-osrm.org/route/v1/driving/${s.lon},${s.lat};${dlon},${dlat}?overview=full&geometries=geojson`)
          .then(r => r.json())
          .then(res => {

            const km = res.routes[0].distance / 1000;
            const cost = (km * s.stawka).toFixed(2);

            const layer = L.geoJSON(res.routes[0].geometry, {
              style: { color: s.color, weight: 4 }
            }).addTo(routesLayer);

            bounds.push(layer.getBounds());

            results.push({ nazwa: s.nazwa, km, cost });

            if (results.length === selected.size) {
              results.sort((a,b) => a.km - b.km);
              renderTable(results);
              map.fitBounds(L.featureGroup(bounds).getBounds());
            }
          });
      });
    });
}

/* ===============================
   TABELA
================================ */
function renderTable(results) {
  const tbody = document.querySelector('#results tbody');
  results.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.nazwa}</td>
      <td>${r.km.toFixed(1)}</td>
      <td>${r.cost}</td>
    `;
    tbody.appendChild(tr);
  });
}
</script>

</body>
</html>
